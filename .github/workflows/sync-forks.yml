name: Sync Forked Repos

on:
  schedule:
    - cron: '0 6 * * 1' # Every Monday at 6am UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-forks:
    runs-on: ubuntu-latest
    steps:
      - name: Sync all forks with upstream
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const owner = 'michelabboud';

            // List all repos for the user
            const repos = await github.paginate(github.rest.repos.listForUser, {
              username: owner,
              type: 'owner',
              per_page: 100,
            });

            const forks = repos.filter(r => r.fork);
            console.log(`Found ${forks.length} forked repos`);

            let synced = 0, skipped = 0, failed = 0;

            for (const fork of forks) {
              const repo = fork.name;
              const defaultBranch = fork.default_branch;

              try {
                // Check for open PRs authored by the owner
                const { data: prs } = await github.rest.pulls.list({
                  owner,
                  repo,
                  state: 'open',
                  per_page: 100,
                });

                const myPRs = prs.filter(pr => pr.user.login === owner);

                if (myPRs.length > 0) {
                  console.log(`⏭️  ${repo}: Skipping — ${myPRs.length} open PR(s) by ${owner}`);
                  skipped++;
                  continue;
                }

                // Sync fork with upstream
                const result = await github.rest.repos.mergeUpstream({
                  owner,
                  repo,
                  branch: defaultBranch,
                });

                if (result.data.merge_type === 'none') {
                  console.log(`ℹ️  ${repo}: Already up to date`);
                } else {
                  console.log(`✅ ${repo}: Synced ${defaultBranch} (${result.data.merge_type})`);
                }
                synced++;
              } catch (error) {
                failed++;
                if (error.status === 409) {
                  console.log(`⚠️  ${repo}: Conflict — manual merge needed`);
                } else {
                  console.log(`❌ ${repo}: Error — ${error.message}`);
                }
              }
            }

            console.log(`\nDone: ${synced} synced, ${skipped} skipped, ${failed} failed`);
